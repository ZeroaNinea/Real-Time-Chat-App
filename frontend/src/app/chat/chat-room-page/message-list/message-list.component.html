@for (msg of filteredMessages; track [msg._id, $index]) {
<div
  class="message"
  [class.own]="msg.sender === currentUserId"
  [class.first]="getMessagePosition($index).isFirstInGroup"
  [class.last]="getMessagePosition($index).isLastInGroup"
  [class.middle]="
    !getMessagePosition($index).isFirstInGroup &&
    !getMessagePosition($index).isLastInGroup
  "
  (mouseenter)="hoveredMessageId = msg._id"
  (mouseleave)="hoveredMessageId = null"
>
  @if (isGrouped($index)) {
  <div class="avatar-wrapper">
    <img [src]="getAvatarUrl(msg.sender)" alt="Avatar" class="user-avatar" />
  </div>
  }

  <div class="message-content">
    @if (isGrouped($index)) {
    <div class="message-header">
      <span class="username">{{ getUsername(msg.sender) }}</span>
      <span class="timestamp">{{ msg.createdAt | date : "shortTime" }}</span>
    </div>
    }

    <!-- @if (msg.replyTo) {
    <div class="quoted-message">
      Replying to: {{ getQuotedText(msg.replyTo) }}
    </div>
    } -->

    <div class="text">
      <span>{{ msg.text }}</span>
      @if (!isGrouped($index) && hoveredMessageId === msg._id) {
      <span class="timestamp">{{ msg.createdAt | date : "shortTime" }}</span>
      }
    </div>
  </div>
  @if (hoveredMessageId === msg._id) {
  <div class="message-actions">
    <button mat-icon-button (click)="onReply(msg)">
      <mat-icon>reply</mat-icon>
    </button>
    <button
      mat-icon-button
      (click)="onEdit.emit({ messageId: msg._id, text: msg.text })"
    >
      <mat-icon>edit</mat-icon>
    </button>
    <button mat-icon-button (click)="onDelete.emit(msg._id)">
      <mat-icon>delete</mat-icon>
    </button>
  </div>
  }
</div>
}
